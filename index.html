<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b1020" />
  <meta name="color-scheme" content="dark light" />
  <title>LEGO War on Narratives ‚Ä¢ Enhanced Multiplayer Platform ‚Ä¢ Foster + Navi</title>

  <!--
    Zero-Harm & Anti-Coercion Note:
    This platform is a consent-forward, nonviolent narrative playground designed to prevent real harm.
    It does NOT encourage harassment, coercion, dehumanization, threats, targeting, or manipulation.
    No telemetry. No tracking. No auto-send. Multiplayer is opt-in via manual export/import.
    All data stored locally. Inputs are sanitized and rate-limited.
    Use for understanding, collaboration, and peace-building‚Äînot pressure or control.
  -->

  <style>
    /* =========================================================
      Design Tokens & Theme System
      Purpose: Centralized styling variables for easy theming
      How to use: Modify CSS variables in :root to change colors, spacing, shadows
      Extension: Add new variables for custom features or themes
    ========================================================== */
    :root {
      /* Color Palette - Deep space theme with regenerative accents */
      --bg0: #060815;
      --bg1: #0b1020;
      --bg2: #101628;
      --card: rgba(255, 255, 255, .06);
      --card2: rgba(255, 255, 255, .09);
      --glass: rgba(255, 255, 255, .04);
      --stroke: rgba(255, 255, 255, .14);
      --stroke2: rgba(255, 255, 255, .22);
      --text: #e9eefc;
      --muted: rgba(233, 238, 252, .72);
      --muted2: rgba(233, 238, 252, .52);
      --dim: rgba(233, 238, 252, .32);
      
      /* Semantic Colors - Peace-aligned palette */
      --good: #53f3a6;
      --warn: #ffd166;
      --bad: #ff5c8a;
      --accent: #7aa2ff;
      --accent2: #9b7bff;
      --info: #5bc0eb;
      
      /* Layout & Spacing */
      --r0: 14px;
      --r1: 18px;
      --r2: 24px;
      --r3: 32px;
      --pad: 14px;
      --pad2: 18px;
      --pad3: 24px;
      --max: 1200px;
      
      /* Shadows & Depth - Enhanced for glassmorphism */
      --shadow: 0 12px 40px rgba(0, 0, 0, .45);
      --shadow2: 0 10px 24px rgba(0, 0, 0, .35);
      --shadow3: 0 6px 16px rgba(0, 0, 0, .25);
      --glow: 0 0 20px rgba(122, 162, 255, .3);
      --glow-good: 0 0 20px rgba(83, 243, 166, .3);
      
      /* Typography */
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }

    /* Base Reset & Body Styling */
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; padding: 0; }
    
    body {
      font-family: var(--sans);
      color: var(--text);
      background: var(--bg1);
      overflow-x: hidden;
      position: relative;
    }

    /* =========================================================
      Particle Canvas Background
      Purpose: Animated particle system for immersive experience
      How it works: Canvas rendered behind all content with interactive particles
      Performance: Optimized with requestAnimationFrame and connection limits
    ========================================================== */
    #particleCanvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
      pointer-events: none;
    }

    /* Gradient Overlay for depth */
    .gradientOverlay {
      position: fixed;
      inset: 0;
      z-index: 1;
      background:
        radial-gradient(1200px 700px at 10% 10%, rgba(122, 162, 255, .18), transparent 55%),
        radial-gradient(1100px 700px at 90% 20%, rgba(155, 123, 255, .16), transparent 60%),
        radial-gradient(900px 600px at 50% 95%, rgba(83, 243, 166, .10), transparent 55%);
      pointer-events: none;
    }

    /* Content Container - Above particle system */
    .content {
      position: relative;
      z-index: 2;
    }

    a { color: var(--accent); text-decoration: none; transition: color .2s; }
    a:hover { color: var(--info); text-decoration: underline; }

    .wrap { width: min(var(--max), calc(100% - 28px)); margin: 0 auto; }

    /* =========================================================
      Sticky Navigation with Glassmorphism
      Purpose: Persistent navigation with blur effect and smooth scrolling
      How to extend: Add new sections with matching href="#section" and id
      Accessibility: Keyboard navigable, ARIA labels included
    ========================================================== */
    header {
      position: sticky;
      top: 0;
      z-index: 50;
      backdrop-filter: blur(16px) saturate(180%);
      background: linear-gradient(180deg, rgba(10, 14, 30, .92), rgba(10, 14, 30, .68));
      border-bottom: 1px solid var(--stroke);
      box-shadow: 0 4px 20px rgba(0, 0, 0, .3);
    }

    .nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 0;
      gap: 12px;
      flex-wrap: wrap;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 200px;
    }

    /* Logo with enhanced depth */
    .logo {
      width: 38px;
      height: 38px;
      border-radius: 14px;
      background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, .35), rgba(255, 255, 255, .08)),
                  linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow: var(--shadow2), var(--glow);
      border: 1px solid rgba(255, 255, 255, .22);
      position: relative;
      animation: logoGlow 4s ease-in-out infinite;
    }

    @keyframes logoGlow {
      0%, 100% { box-shadow: var(--shadow2), var(--glow); }
      50% { box-shadow: var(--shadow2), 0 0 30px rgba(122, 162, 255, .5); }
    }

    .logo::after {
      content: "";
      position: absolute;
      inset: 8px;
      border-radius: 10px;
      border: 1px dashed rgba(255, 255, 255, .28);
      opacity: .9;
    }

    .brand h1 {
      margin: 0;
      font-size: 15px;
      letter-spacing: .4px;
      line-height: 1.2;
      font-weight: 600;
    }

    .brand .sub {
      display: block;
      font-size: 11px;
      color: var(--muted);
      margin-top: 2px;
    }

    /* Navigation Pills */
    .navlinks {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
      align-items: center;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 7px 11px;
      border: 1px solid var(--stroke);
      background: var(--glass);
      backdrop-filter: blur(8px);
      border-radius: 999px;
      color: var(--text);
      font-size: 12px;
      white-space: nowrap;
      box-shadow: var(--shadow3);
      transition: all .2s ease;
    }

    .pill:hover {
      border-color: var(--stroke2);
      background: var(--card);
      transform: translateY(-1px);
      box-shadow: var(--shadow2);
      text-decoration: none;
    }

    .right {
      display: flex;
      gap: 8px;
      align-items: center;
      justify-content: flex-end;
      min-width: 200px;
    }

    /* =========================================================
      Form Controls & Interactive Elements
      Purpose: Accessible, beautiful form inputs with focus states
      Accessibility: Proper labels, focus indicators, keyboard navigation
    ========================================================== */
    button, input, select, textarea {
      font: inherit;
      color: inherit;
    }

    .btn {
      border: 1px solid var(--stroke);
      background: var(--card);
      padding: 11px 14px;
      border-radius: 14px;
      cursor: pointer;
      transition: transform .08s ease, background .2s ease, border .2s ease, box-shadow .2s ease;
      box-shadow: var(--shadow3);
      font-weight: 500;
      font-size: 13px;
    }

    .btn:hover {
      background: var(--card2);
      border-color: var(--stroke2);
      transform: translateY(-1px);
      box-shadow: var(--shadow2);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn:disabled {
      opacity: .5;
      cursor: not-allowed;
    }

    .btn.primary {
      border-color: rgba(122, 162, 255, .55);
      background: linear-gradient(135deg, rgba(122, 162, 255, .24), rgba(155, 123, 255, .20));
      box-shadow: var(--shadow3), 0 0 12px rgba(122, 162, 255, .2);
    }

    .btn.primary:hover {
      box-shadow: var(--shadow2), 0 0 20px rgba(122, 162, 255, .3);
    }

    .btn.danger {
      border-color: rgba(255, 92, 138, .55);
      background: linear-gradient(135deg, rgba(255, 92, 138, .20), rgba(255, 209, 102, .12));
    }

    .btn.good {
      border-color: rgba(83, 243, 166, .55);
      background: linear-gradient(135deg, rgba(83, 243, 166, .20), rgba(122, 162, 255, .14));
      box-shadow: var(--shadow3), 0 0 12px rgba(83, 243, 166, .2);
    }

    .btn.good:hover {
      box-shadow: var(--shadow2), 0 0 20px rgba(83, 243, 166, .3);
    }

    .btn.small {
      padding: 8px 10px;
      border-radius: 12px;
      font-size: 12px;
    }

    .btn.ghost {
      background: transparent;
      box-shadow: none;
      border-color: transparent;
    }

    .btn.ghost:hover {
      background: var(--glass);
      border-color: var(--stroke);
    }

    /* Form Fields */
    .field {
      display: flex;
      flex-direction: column;
      gap: 7px;
    }

    .field label {
      font-size: 12px;
      color: var(--muted);
      font-weight: 500;
    }

    .input, .select, .textarea {
      border: 1px solid var(--stroke);
      background: var(--glass);
      backdrop-filter: blur(8px);
      border-radius: 14px;
      padding: 11px 13px;
      outline: none;
      transition: border .2s, box-shadow .2s;
    }

    .textarea {
      min-height: 100px;
      resize: vertical;
      font-family: var(--sans);
      line-height: 1.5;
    }

    .input:focus, .select:focus, .textarea:focus {
      border-color: rgba(122, 162, 255, .65);
      box-shadow: 0 0 0 4px rgba(122, 162, 255, .12), 0 0 16px rgba(122, 162, 255, .15);
    }

    /* =========================================================
      Splash Screen with Animation
      Purpose: Polished loading experience with auto-dismiss
      How to customize: Adjust SPLASH_MS in JavaScript
      Accessibility: Can be dismissed immediately via button
    ========================================================== */
    #splash {
      position: fixed;
      inset: 0;
      z-index: 1000;
      background:
        radial-gradient(900px 600px at 30% 20%, rgba(122, 162, 255, .28), transparent 55%),
        radial-gradient(900px 600px at 70% 30%, rgba(155, 123, 255, .25), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
      opacity: 1;
      transition: opacity .3s ease;
    }

    #splash.fadeOut {
      opacity: 0;
      pointer-events: none;
    }

    .splashCard {
      width: min(800px, 100%);
      border-radius: 32px;
      border: 1px solid rgba(255, 255, 255, .18);
      background: linear-gradient(135deg, rgba(255, 255, 255, .08), rgba(255, 255, 255, .04));
      backdrop-filter: blur(20px) saturate(180%);
      box-shadow: var(--shadow), 0 0 60px rgba(122, 162, 255, .2);
      padding: 48px 40px;
      text-align: center;
      animation: splashFloat 3s ease-in-out infinite;
    }

    @keyframes splashFloat {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-8px); }
    }

    .splashLogo {
      width: 72px;
      height: 72px;
      margin: 0 auto 24px;
      border-radius: 24px;
      background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, .4), rgba(255, 255, 255, .1)),
                  linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow: var(--shadow), var(--glow);
      border: 2px solid rgba(255, 255, 255, .25);
      position: relative;
      animation: logoSpin 8s linear infinite;
    }

    @keyframes logoSpin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .splashLogo::after {
      content: "";
      position: absolute;
      inset: 14px;
      border-radius: 16px;
      border: 2px dashed rgba(255, 255, 255, .35);
    }

    .splashCard h2 {
      margin: 0 0 12px;
      font-size: 32px;
      letter-spacing: -.5px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .splashCard p {
      margin: 0 0 28px;
      color: var(--muted);
      font-size: 15px;
      line-height: 1.6;
    }

    .splashBtns {
      display: flex;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .countdown {
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid var(--stroke);
      font-size: 13px;
      color: var(--muted2);
    }

    /* =========================================================
      Card System with Glassmorphism
      Purpose: Modular content containers with depth and clarity
      How to use: Wrap sections in .card divs for consistent styling
    ========================================================== */
    .card {
      background: linear-gradient(135deg, rgba(255, 255, 255, .08), rgba(255, 255, 255, .04));
      backdrop-filter: blur(12px) saturate(180%);
      border: 1px solid var(--stroke);
      border-radius: var(--r2);
      padding: var(--pad3);
      box-shadow: var(--shadow3);
      margin-bottom: 24px;
    }

    .card h2 {
      margin: 0 0 16px;
      font-size: 24px;
      font-weight: 600;
      letter-spacing: -.3px;
    }

    .card h3 {
      margin: 20px 0 12px;
      font-size: 18px;
      font-weight: 600;
      color: var(--text);
    }

    .card p {
      margin: 0 0 14px;
      line-height: 1.7;
      color: var(--muted);
    }

    .card ul, .card ol {
      margin: 0 0 14px;
      padding-left: 24px;
      line-height: 1.7;
      color: var(--muted);
    }

    .card li {
      margin-bottom: 8px;
    }

    .hint {
      font-size: 13px;
      color: var(--muted2);
      font-style: italic;
      padding: 12px 16px;
      background: rgba(122, 162, 255, .08);
      border-left: 3px solid var(--accent);
      border-radius: 8px;
      margin: 16px 0;
    }

    .sep {
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--stroke), transparent);
      margin: 32px 0;
    }

    /* =========================================================
      Toast Notification System
      Purpose: Non-intrusive feedback for user actions
      How it works: JavaScript creates toast divs that auto-remove
      Accessibility: Announced to screen readers via aria-live
    ========================================================== */
    .toasts {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 100;
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-width: 400px;
    }

    .toast {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 14px 18px;
      background: linear-gradient(135deg, rgba(255, 255, 255, .12), rgba(255, 255, 255, .08));
      backdrop-filter: blur(16px) saturate(180%);
      border: 1px solid var(--stroke2);
      border-radius: 16px;
      box-shadow: var(--shadow);
      animation: toastSlide .3s ease;
    }

    @keyframes toastSlide {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .toast .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--good);
      box-shadow: 0 0 12px currentColor;
      flex-shrink: 0;
      margin-top: 4px;
      animation: dotPulse 2s ease infinite;
    }

    @keyframes dotPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: .6; }
    }

    .toast.warn .dot { background: var(--warn); }
    .toast.bad .dot { background: var(--bad); }
    .toast.info .dot { background: var(--info); }

    .toast .t {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 2px;
    }

    .toast .s {
      font-size: 12px;
      color: var(--muted);
    }

    /* =========================================================
      Role System Cards
      Purpose: Visual role selection with weighted attributes
      Extensibility: Add new roles in JavaScript ROLES array
    ========================================================== */
    .roleGrid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
      margin: 20px 0;
    }

    .roleCard {
      padding: 20px;
      background: linear-gradient(135deg, rgba(255, 255, 255, .06), rgba(255, 255, 255, .03));
      border: 1px solid var(--stroke);
      border-radius: var(--r1);
      cursor: pointer;
      transition: all .2s ease;
      position: relative;
      overflow: hidden;
    }

    .roleCard::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      opacity: 0;
      transition: opacity .2s;
    }

    .roleCard:hover {
      border-color: var(--stroke2);
      background: linear-gradient(135deg, rgba(255, 255, 255, .09), rgba(255, 255, 255, .05));
      transform: translateY(-2px);
      box-shadow: var(--shadow3);
    }

    .roleCard:hover::before {
      opacity: 1;
    }

    .roleCard.selected {
      border-color: var(--accent);
      background: linear-gradient(135deg, rgba(122, 162, 255, .15), rgba(155, 123, 255, .10));
      box-shadow: 0 0 20px rgba(122, 162, 255, .2);
    }

    .roleCard.selected::before {
      opacity: 1;
    }

    .roleCard h4 {
      margin: 0 0 8px;
      font-size: 18px;
      color: var(--text);
    }

    .roleCard p {
      margin: 0 0 12px;
      font-size: 13px;
      color: var(--muted2);
      line-height: 1.6;
    }

    .roleWeights {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .weightBadge {
      padding: 4px 10px;
      background: rgba(122, 162, 255, .15);
      border: 1px solid rgba(122, 162, 255, .3);
      border-radius: 12px;
      font-size: 11px;
      color: var(--accent);
    }

    /* =========================================================
      Voting Interface
      Purpose: Spectrum-based voting on policy traits
      How it works: Range sliders with visual feedback and labels
      Accessibility: Keyboard controls, ARIA labels, focus states
    ========================================================== */
    .voteList {
      display: flex;
      flex-direction: column;
      gap: 20px;
      margin: 20px 0;
    }

    .voteCard {
      padding: 24px;
      background: linear-gradient(135deg, rgba(255, 255, 255, .06), rgba(255, 255, 255, .03));
      border: 1px solid var(--stroke);
      border-radius: var(--r1);
      transition: all .2s ease;
    }

    .voteCard:hover {
      border-color: var(--stroke2);
      box-shadow: var(--shadow3);
    }

    .voteTop {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 18px;
      gap: 12px;
    }

    .voteTop h4 {
      margin: 0;
      font-size: 17px;
      font-weight: 600;
      color: var(--text);
    }

    .meta {
      display: inline-block;
      padding: 4px 10px;
      background: rgba(155, 123, 255, .15);
      border: 1px solid rgba(155, 123, 255, .3);
      border-radius: 12px;
      font-size: 11px;
      color: var(--accent2);
      text-transform: uppercase;
      letter-spacing: .5px;
      margin-top: 6px;
    }

    /* Custom Range Slider Styling */
    .axis {
      display: grid;
      grid-template-columns: 1fr auto 60px auto 1fr;
      gap: 14px;
      align-items: center;
    }

    .pole {
      font-size: 13px;
      color: var(--muted);
      text-align: center;
    }

    .value {
      font-size: 18px;
      font-weight: 700;
      font-family: var(--mono);
      color: var(--accent);
      text-align: center;
      min-width: 60px;
      padding: 8px;
      background: rgba(122, 162, 255, .10);
      border: 1px solid rgba(122, 162, 255, .25);
      border-radius: 12px;
    }

    input[type="range"] {
      -webkit-appearance: none;
      appearance: none;
      width: 100%;
      height: 8px;
      border-radius: 8px;
      background: linear-gradient(90deg,
        rgba(255, 92, 138, .3) 0%,
        rgba(255, 209, 102, .2) 25%,
        rgba(255, 255, 255, .1) 50%,
        rgba(122, 162, 255, .2) 75%,
        rgba(83, 243, 166, .3) 100%
      );
      outline: none;
      cursor: pointer;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      border: 2px solid rgba(255, 255, 255, .3);
      box-shadow: var(--shadow3), 0 0 12px rgba(122, 162, 255, .4);
      cursor: pointer;
      transition: transform .1s ease;
    }

    input[type="range"]::-webkit-slider-thumb:hover {
      transform: scale(1.15);
    }

    input[type="range"]::-moz-range-thumb {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      border: 2px solid rgba(255, 255, 255, .3);
      box-shadow: var(--shadow3), 0 0 12px rgba(122, 162, 255, .4);
      cursor: pointer;
      transition: transform .1s ease;
    }

    input[type="range"]::-moz-range-thumb:hover {
      transform: scale(1.15);
    }

    /* =========================================================
      Dashboard & Visualizations
      Purpose: Real-time data visualization of voting patterns
      How it works: Canvas-based charts updated from vote data
      Extensibility: Add new chart types in renderCharts()
    ========================================================== */
    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin: 24px 0;
    }

    .statCard {
      padding: 20px;
      background: linear-gradient(135deg, rgba(255, 255, 255, .06), rgba(255, 255, 255, .03));
      border: 1px solid var(--stroke);
      border-radius: var(--r1);
      text-align: center;
    }

    .statLabel {
      font-size: 12px;
      color: var(--muted2);
      text-transform: uppercase;
      letter-spacing: .8px;
      margin-bottom: 8px;
    }

    .statValue {
      font-size: 36px;
      font-weight: 700;
      font-family: var(--mono);
      color: var(--accent);
      margin-bottom: 4px;
      text-shadow: 0 0 20px rgba(122, 162, 255, .3);
    }

    .statSub {
      font-size: 12px;
      color: var(--muted2);
    }

    .chartContainer {
      width: 100%;
      height: 300px;
      background: rgba(0, 0, 0, .2);
      border: 1px solid var(--stroke);
      border-radius: var(--r1);
      padding: 16px;
      margin: 20px 0;
    }

    canvas.chart {
      width: 100%;
      height: 100%;
    }

    /* =========================================================
      Search Interface
      Purpose: Fast client-side search across all content
      How it works: Keyword matching with instant results
      Accessibility: Keyboard navigation of results
    ========================================================== */
    .searchResults {
      margin-top: 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .searchResult {
      padding: 14px 16px;
      background: rgba(122, 162, 255, .08);
      border: 1px solid rgba(122, 162, 255, .2);
      border-radius: 12px;
      cursor: pointer;
      transition: all .2s ease;
    }

    .searchResult:hover {
      background: rgba(122, 162, 255, .12);
      border-color: rgba(122, 162, 255, .35);
      transform: translateX(4px);
    }

    .searchResult strong {
      color: var(--accent);
      font-weight: 600;
    }

    .searchResult .category {
      font-size: 11px;
      color: var(--muted2);
      margin-top: 4px;
    }

    /* =========================================================
      Multiplayer Sync Status
      Purpose: Visual feedback for import/export activity
      How it works: Shows connection status and peer count
    ========================================================== */
    .syncStatus {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      background: rgba(83, 243, 166, .08);
      border: 1px solid rgba(83, 243, 166, .25);
      border-radius: 14px;
      margin: 16px 0;
    }

    .syncDot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--good);
      box-shadow: 0 0 12px var(--good);
      animation: syncPulse 2s ease infinite;
    }

    @keyframes syncPulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: .6; transform: scale(1.2); }
    }

    .syncStatus.offline .syncDot {
      background: var(--muted2);
      box-shadow: none;
      animation: none;
    }

    /* =========================================================
      Reflection & Insight Section
      Purpose: Encourage thoughtful participation and learning
      Design: Softer styling to indicate contemplative space
    ========================================================== */
    .reflectionCard {
      padding: 24px;
      background: linear-gradient(135deg, rgba(83, 243, 166, .08), rgba(122, 162, 255, .06));
      border: 1px solid rgba(83, 243, 166, .2);
      border-radius: var(--r2);
      margin: 24px 0;
    }

    .reflectionCard h3 {
      margin: 0 0 12px;
      color: var(--good);
    }

    .reflectionCard p {
      margin: 0 0 16px;
      line-height: 1.7;
    }

    .prompt {
      padding: 16px;
      background: rgba(255, 255, 255, .04);
      border-left: 3px solid var(--good);
      border-radius: 8px;
      font-style: italic;
      color: var(--muted);
      margin: 12px 0;
    }

    /* =========================================================
      Responsive Design
      Purpose: Ensure usability across all device sizes
      Breakpoints: Optimized for mobile, tablet, and desktop
    ========================================================== */
    @media (max-width: 768px) {
      .nav {
        flex-direction: column;
        align-items: stretch;
      }

      .brand, .right {
        min-width: auto;
        justify-content: center;
      }

      .navlinks {
        order: 3;
        width: 100%;
      }

      .roleGrid {
        grid-template-columns: 1fr;
      }

      .dashboard {
        grid-template-columns: 1fr;
      }

      .axis {
        grid-template-columns: 1fr;
        gap: 10px;
      }

      .pole {
        text-align: left;
      }

      .value {
        justify-self: start;
      }

      .toasts {
        left: 12px;
        right: 12px;
        bottom: 12px;
        max-width: none;
      }
    }

    /* =========================================================
      Loading & Error States
      Purpose: Clear feedback during async operations
    ========================================================== */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, .2);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .error {
      padding: 16px;
      background: rgba(255, 92, 138, .12);
      border: 1px solid rgba(255, 92, 138, .3);
      border-left: 3px solid var(--bad);
      border-radius: 8px;
      color: var(--bad);
      margin: 12px 0;
    }

    .success {
      padding: 16px;
      background: rgba(83, 243, 166, .12);
      border: 1px solid rgba(83, 243, 166, .3);
      border-left: 3px solid var(--good);
      border-radius: 8px;
      color: var(--good);
      margin: 12px 0;
    }

    /* =========================================================
      Accessibility Enhancements
      Purpose: Ensure platform is usable by everyone
      Features: Focus indicators, skip links, screen reader text
    ========================================================== */
    .skipLink {
      position: absolute;
      top: -40px;
      left: 0;
      background: var(--accent);
      color: white;
      padding: 8px 12px;
      text-decoration: none;
      z-index: 9999;
    }

    .skipLink:focus {
      top: 0;
    }

    .srOnly {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border-width: 0;
    }

    /* Focus visible for keyboard navigation */
    *:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }
  </style>
</head>
<body>
  <!-- Accessibility: Skip to main content -->
  <a href="#main" class="skipLink">Skip to main content</a>

  <!-- Particle Canvas Background -->
  <canvas id="particleCanvas" aria-hidden="true"></canvas>
  <div class="gradientOverlay" aria-hidden="true"></div>

  <!-- Toast Container (for notifications) -->
  <div class="toasts" id="toasts" role="status" aria-live="polite" aria-atomic="true"></div>

  <!-- Main Content Container -->
  <div class="content">
    <!-- =========================================================
      Splash Screen - Initial Loading Experience
      Purpose: Welcome users and explain the platform
      Auto-dismisses: After 5 seconds (configurable)
      Manual dismiss: Click button or press Escape
    ========================================================== -->
    <div id="splash" role="dialog" aria-labelledby="splashTitle" aria-describedby="splashDesc">
      <div class="splashCard">
        <div class="splashLogo" aria-hidden="true"></div>
        <h2 id="splashTitle">LEGO War on Narratives</h2>
        <p id="splashDesc">
          A consent-forward platform for collaborative deliberation and peace-building.
          Vote on policy spectrums, share perspectives with peers, and visualize community consensus‚Äîall
          stored locally with zero tracking or coercion.
        </p>
        <p style="font-size: 13px; color: var(--muted2); margin-bottom: 28px;">
          <strong>Zero-Harm Design:</strong> No telemetry. No auto-send. Manual multiplayer only.
          Everything happens on your device. Use this space for understanding, not pressure.
        </p>
        <div class="splashBtns">
          <button class="btn primary" id="splashEnter">Enter Platform</button>
          <button class="btn ghost" id="splashLearn">Learn More</button>
        </div>
        <div class="countdown" id="countdown">Auto-entering in <span id="countdownValue">5</span>s</div>
      </div>
    </div>

    <!-- =========================================================
      Sticky Navigation - Persistent Access to All Sections
      Purpose: Quick navigation and status indicators
      Accessibility: Keyboard navigable, semantic HTML
    ========================================================== -->
    <header>
      <nav class="wrap">
        <div class="nav">
          <div class="brand">
            <div class="logo" role="img" aria-label="Platform logo"></div>
            <h1>
              LEGO War on Narratives
              <span class="sub">Enhanced Multiplayer Platform</span>
            </h1>
          </div>

          <div class="navlinks">
            <a href="#profile" class="pill">üë§ Profile</a>
            <a href="#voting" class="pill">üó≥Ô∏è Vote</a>
            <a href="#dashboard" class="pill">üìä Dashboard</a>
            <a href="#multiplayer" class="pill">üåê Multiplayer</a>
            <a href="#insights" class="pill">üí° Insights</a>
            <a href="#search" class="pill">üîé Search</a>
            <a href="#safety" class="pill">üõ°Ô∏è Safety</a>
          </div>

          <div class="right">
            <button class="btn small ghost" id="btnToggleTheme" aria-label="Toggle theme">üåì</button>
            <button class="btn small" id="btnHelp" aria-label="Help">‚ùì</button>
          </div>
        </div>
      </nav>
    </header>

    <!-- =========================================================
      Main Content Area
      Purpose: Houses all interactive sections and features
      Structure: Sequential sections with clear headings
    ========================================================== -->
    <main id="main" class="wrap" style="padding: 32px 0;">

      <!-- =========================================================
        Profile Section - User Identity and Role Selection
        Purpose: Set context for weighted voting
        How it works: Role selection affects vote weighting
        Extensibility: Add new roles in JavaScript ROLES array
      ========================================================== -->
      <section id="profile">
        <div class="card">
          <h2>Your Profile üë§</h2>
          <p>
            Set your identity and role to participate in deliberations. Your role influences how
            the system weights your votes across different categories. All data is stored locally
            on your device‚Äîno accounts, no server uploads.
          </p>

          <div class="field">
            <label for="username">Name or Pseudonym (local only)</label>
            <input
              class="input"
              id="username"
              type="text"
              placeholder="e.g., Alex Peace-Builder"
              autocomplete="off"
            />
          </div>

          <div class="field" style="margin-top: 16px;">
            <label for="sideLabel">Affiliation or Perspective (optional)</label>
            <select class="select" id="sideLabel">
              <option value="">None / Neutral</option>
              <option value="Environmental Justice">Environmental Justice</option>
              <option value="Economic Reform">Economic Reform</option>
              <option value="Indigenous Rights">Indigenous Rights</option>
              <option value="Youth Voices">Youth Voices</option>
              <option value="Academic Research">Academic Research</option>
              <option value="Community Organizer">Community Organizer</option>
              <option value="Other">Other (specify below)</option>
            </select>
          </div>

          <div class="field" id="customSideWrap" style="display: none; margin-top: 16px;">
            <label for="customSide">Custom Affiliation</label>
            <input class="input" id="customSide" placeholder="Describe your perspective" />
          </div>

          <h3>Select Your Role</h3>
          <p class="hint">
            Each role has specialized influence on certain categories. Choose the role that best
            matches your expertise or interest.
          </p>

          <div class="roleGrid" id="roleGrid">
            <!-- Populated by JavaScript -->
          </div>

          <button class="btn good" id="btnSaveProfile" style="margin-top: 16px;">
            üíæ Save Profile
          </button>
        </div>
      </section>

      <!-- =========================================================
        Voting Section - Core Deliberation Interface
        Purpose: Collect weighted votes on policy spectrums
        How it works: Range sliders from -2 to +2 on key traits
        Design: Visual feedback with real-time value display
      ========================================================== -->
      <section id="voting">
        <div class="card">
          <h2>Voting on Narratives üó≥Ô∏è</h2>
          <p>
            Each "round" presents a set of policy spectrums. Slide to express your position along
            each axis. Your role weights certain categories more heavily, but all voices contribute
            to the collective picture.
          </p>

          <div style="display: flex; justify-content: space-between; align-items: center; margin: 20px 0;">
            <div>
              <strong>Current Round:</strong>
              <span id="roundLabel" style="font-size: 24px; color: var(--accent); margin-left: 8px;">0</span>
            </div>
            <button class="btn primary" id="btnNewRound">üÜï Start New Round</button>
          </div>

          <div class="voteList" id="voteList">
            <p style="color: var(--muted2); text-align: center; padding: 40px 0;">
              Click "Start New Round" to begin voting.
            </p>
          </div>

          <div style="display: flex; gap: 12px; margin-top: 24px; flex-wrap: wrap;">
            <button class="btn good" id="btnSubmitVotes" disabled>
              ‚úÖ Submit Votes (Local Only)
            </button>
            <button class="btn ghost" id="btnClearVotes">
              üîÑ Reset Current Round
            </button>
          </div>

          <div class="reflectionCard" style="margin-top: 24px;">
            <h3>Reflection Prompt</h3>
            <div class="prompt">
              Before submitting: How might your votes affect communities different from your own?
              What voices or perspectives are you accounting for in your choices?
            </div>
            <textarea
              class="textarea"
              id="reflectionNotes"
              placeholder="Optional: Write your thoughts here. These notes stay on your device."
            ></textarea>
          </div>
        </div>
      </section>

      <!-- =========================================================
        Dashboard Section - Data Visualization
        Purpose: Show voting trends, consensus, and diversity
        How it works: Charts rendered from vote data in IndexedDB
        Features: Real-time updates, multiple chart types
      ========================================================== -->
      <section id="dashboard">
        <div class="card">
          <h2>Dashboard & Insights üìä</h2>
          <p>
            Visualize your voting patterns and compare them with imported perspectives. The dashboard
            shows how different roles and viewpoints distribute across the spectrum.
          </p>

          <div class="dashboard">
            <div class="statCard">
              <div class="statLabel">Total Rounds</div>
              <div class="statValue" id="statRounds">0</div>
              <div class="statSub">Completed deliberations</div>
            </div>

            <div class="statCard">
              <div class="statLabel">Total Votes Cast</div>
              <div class="statValue" id="statVotes">0</div>
              <div class="statSub">Across all rounds</div>
            </div>

            <div class="statCard">
              <div class="statLabel">Perspectives Imported</div>
              <div class="statValue" id="statImports">0</div>
              <div class="statSub">From other participants</div>
            </div>
          </div>

          <h3>Voting Distribution</h3>
          <p style="color: var(--muted2); font-size: 13px;">
            This chart shows how votes are distributed across the spectrum for each trait.
            Green indicates high consensus; scattered patterns show diversity of opinion.
          </p>
          <div class="chartContainer">
            <canvas class="chart" id="distributionChart" aria-label="Voting distribution chart"></canvas>
          </div>

          <h3>Consensus Heatmap</h3>
          <p style="color: var(--muted2); font-size: 13px;">
            Visualizes where strong agreement exists (bright areas) versus areas of constructive
            disagreement (scattered or muted areas).
          </p>
          <div class="chartContainer">
            <canvas class="chart" id="consensusChart" aria-label="Consensus heatmap"></canvas>
          </div>
        </div>
      </section>

      <!-- =========================================================
        Multiplayer Section - Manual Share Packs
        Purpose: Coordinate with peers without centralized servers
        How it works: Export JSON, share file, others import
        Design: Emphasizes consent and manual action
      ========================================================== -->
      <section id="multiplayer">
        <div class="card">
          <h2>Multiplayer Coordination üåê</h2>
          <p>
            Share your deliberations with others via "Share Packs"‚ÄîJSON files you export and manually
            send. Recipients import them to see your votes alongside theirs. No automatic sync, no
            servers, no tracking.
          </p>

          <div class="syncStatus offline" id="syncStatus">
            <div class="syncDot" aria-hidden="true"></div>
            <div>
              <strong>Status:</strong> Offline (as designed)
              <div class="statSub">All coordination is manual and consent-based</div>
            </div>
          </div>

          <h3>Export Your Share Pack</h3>
          <p>
            Creates a JSON file containing your session ID, rounds, and votes. Share this file with
            trusted peers through any channel you prefer (email, messaging, shared drive, etc.).
          </p>
          <button class="btn primary" id="btnExport">
            üì§ Export Share Pack
          </button>

          <div class="sep"></div>

          <h3>Import Others' Share Packs</h3>
          <p>
            Upload JSON files from peers to merge their perspectives into your local view. This helps
            you see how your community is thinking about these issues. All imported data stays local.
          </p>
          <input type="file" accept=".json" id="importFile" style="display: none;" />
          <div style="display: flex; gap: 12px; flex-wrap: wrap;">
            <button class="btn good" id="btnImport">
              üì• Import Share Pack
            </button>
            <button class="btn danger small" id="btnClearImports">
              üóëÔ∏è Clear All Imports
            </button>
          </div>

          <div id="importList" style="margin-top: 16px;">
            <!-- Populated dynamically -->
          </div>
        </div>
      </section>

      <!-- =========================================================
        Insights Section - Learning and Reflection
        Purpose: Encourage growth, empathy, and understanding
        Design: Generative prompts, community patterns, resources
      ========================================================== -->
      <section id="insights">
        <div class="card">
          <h2>Insights & Reflection üí°</h2>
          <p>
            Beyond voting, use this space to deepen your understanding. The platform generates
            reflection prompts based on your patterns and offers resources for learning more about
            different perspectives.
          </p>

          <div class="reflectionCard">
            <h3>This Week's Reflection</h3>
            <div class="prompt">
              "Consider a position you strongly disagreed with this week. Can you articulate the
              strongest version of that argument‚Äîthe one its advocates would recognize as fair?"
            </div>
            <textarea
              class="textarea"
              placeholder="Your response (stored locally)..."
              id="weeklyReflection"
            ></textarea>
          </div>

          <h3>Community Patterns</h3>
          <p>
            Based on imported share packs, here's what the collective data suggests about this community's
            deliberation style:
          </p>
          <ul id="communityPatterns">
            <li>Waiting for data... Import some share packs to see patterns.</li>
          </ul>

          <h3>Learning Resources</h3>
          <p>
            Expand your understanding with these curated resources. All links lead to educational,
            non-commercial content about collaborative governance and peace-building.
          </p>
          <ul>
            <li>
              <a href="https://www.planetaryrestorationarchive.com" target="_blank" rel="noopener">
                Planetary Restoration Archive
              </a> - Foster + Navi's main hub for regenerative systems
            </li>
            <li>
              <a href="https://en.wikipedia.org/wiki/Deliberative_democracy" target="_blank" rel="noopener">
                Deliberative Democracy (Wikipedia)
              </a> - Background on participatory governance
            </li>
            <li>
              <a href="https://en.wikipedia.org/wiki/Restorative_justice" target="_blank" rel="noopener">
                Restorative Justice (Wikipedia)
              </a> - Principles of healing over punishment
            </li>
          </ul>
        </div>
      </section>

      <!-- =========================================================
        Search Section - Quick Content Lookup
        Purpose: Find specific traits, roles, or help text instantly
        How it works: Client-side keyword matching across all content
        Accessibility: Keyboard navigation, results announced to screen readers
      ========================================================== -->
      <section id="search">
        <div class="card">
          <h2>Search üîé</h2>
          <p>
            Quickly find information about roles, voting traits, or help documentation. Search is
            instant and happens entirely in your browser.
          </p>
          <div class="field">
            <label for="searchInput">Enter keywords</label>
            <input
              class="input"
              id="searchInput"
              type="search"
              placeholder="e.g., reversibility, steward, coercion, transparency..."
              autocomplete="off"
            />
          </div>
          <div class="searchResults" id="searchResults" role="region" aria-live="polite">
            <!-- Results populated by JavaScript -->
          </div>
        </div>
      </section>

      <!-- =========================================================
        Safety Section - Guardrails and Autonomy Controls
        Purpose: Transparent explanation of anti-harm design
        Features: Reset button, explanation of constraints
      ========================================================== -->
      <section id="safety">
        <div class="card">
          <h2>Safety, Zero-Harm, and Autonomy üõ°Ô∏è</h2>
          <p>
            This platform is intentionally limited to prevent misuse. It cannot target people,
            automate outreach, or centralize control. Everything meaningful happens locally on
            your device.
          </p>

          <h3>Core Safeguards</h3>
          <ul>
            <li><strong>No telemetry or analytics:</strong> We don't track you or collect usage data</li>
            <li><strong>No automatic sync:</strong> Multiplayer requires manual file export/import</li>
            <li><strong>Local-first storage:</strong> All votes and data stay in your browser's IndexedDB</li>
            <li><strong>Resettable at any time:</strong> Full control to wipe your data instantly</li>
            <li><strong>Input sanitization:</strong> Text inputs are cleaned to prevent injection attacks</li>
            <li><strong>Rate limiting:</strong> Prevents spam or abuse through gentle throttling</li>
          </ul>

          <h3>Architectural Constraints</h3>
          <p>
            The system is designed from the ground up to favor reversibility over power, transparency
            over secrecy, and autonomy over control. These aren't just policies‚Äîthey're baked into
            the code architecture.
          </p>

          <div class="hint">
            <strong>Zero-Harm Principle:</strong> If a feature could be weaponized for harassment,
            coercion, or manipulation, it's either removed or constrained until it can't be.
            This is non-negotiable.
          </div>

          <h3>Reset Your Data</h3>
          <p>
            Wipes all local data: profile, votes, imported packs, and preferences. This action is
            immediate and cannot be undone. Your browser will be returned to a clean state.
          </p>
          <button class="btn danger" id="btnReset">
            ‚ö†Ô∏è Reset All Local Data
          </button>
        </div>
      </section>

      <!-- =========================================================
        Help & Documentation Section
        Purpose: In-depth guide for new and experienced users
        Accessibility: Clear headings, simple language
      ========================================================== -->
      <section id="help" style="margin-top: 32px;">
        <div class="card">
          <h2>Help & Documentation üìò</h2>
          <p>
            Welcome to the LEGO War on Narratives platform! This system helps groups deliberate on
            complex policy questions using spectrum-based voting. Here's everything you need to know.
          </p>

          <h3>How It Works</h3>
          <ol>
            <li>
              <strong>Set up your profile:</strong> Choose a name (or pseudonym) and role. Your role
              affects how your votes are weighted across different categories.
            </li>
            <li>
              <strong>Start a round:</strong> Each round presents five policy spectrums (traits like
              "Transparency vs. Opacity"). Vote by sliding along each axis.
            </li>
            <li>
              <strong>Reflect before submitting:</strong> Take a moment to consider how your votes
              might affect others. Write notes if you'd like.
            </li>
            <li>
              <strong>Submit votes locally:</strong> Your votes are saved to your device's IndexedDB.
              No one else can see them unless you explicitly export and share.
            </li>
            <li>
              <strong>Export & share:</strong> Create a Share Pack (JSON file) and send it to peers
              through your preferred channel.
            </li>
            <li>
              <strong>Import others' packs:</strong> When you receive Share Packs, import them to
              see how your community is thinking about these issues.
            </li>
            <li>
              <strong>Explore insights:</strong> Check the Dashboard and Insights sections to see
              patterns, trends, and community consensus.
            </li>
          </ol>

          <h3>Understanding Roles</h3>
          <p>
            Each role has expertise in certain areas, reflected by vote weights:
          </p>
          <ul>
            <li><strong>Architect:</strong> Specializes in mechanisms and design (mechanics +10%)</li>
            <li><strong>Steward:</strong> Focuses on sustainability and long-term effects (sustainability +15%)</li>
            <li><strong>Auditor:</strong> Expert at spotting abuse and vulnerabilities (abuse +20%)</li>
            <li><strong>Mediator:</strong> Skilled in synthesis and bridging divides (synthesis +15%)</li>
            <li><strong>Historian:</strong> Considers precedent and long-term consequences (precedent +10%)</li>
            <li><strong>Citizen:</strong> General participant with no specialized weighting</li>
          </ul>

          <h3>Understanding Traits</h3>
          <p>
            Each trait is a spectrum with two poles. You vote on where you believe a policy should
            fall along that axis:
          </p>
          <ul>
            <li><strong>Transparency ‚Üî Opacity:</strong> Should processes be fully open or strategically private?</li>
            <li><strong>Reversibility ‚Üî Permanence:</strong> Should decisions be easy to undo or locked in?</li>
            <li><strong>Deliberation ‚Üî Speed:</strong> Should we move slowly with care or quickly with urgency?</li>
            <li><strong>Local Autonomy ‚Üî Central Coordination:</strong> Who decides‚Äîcommunities or centralized authority?</li>
            <li><strong>Compassion Bias ‚Üî Efficiency Bias:</strong> Prioritize human welfare or operational efficiency?</li>
          </ul>

          <h3>Privacy & Data</h3>
          <p>
            Your data never leaves your device unless you explicitly export it. The platform uses
            IndexedDB (a local browser database) to store your profile, votes, and imported packs.
            You can reset everything at any time from the Safety section.
          </p>

          <h3>Extending the Platform</h3>
          <p>
            This is open-source software! You can:
          </p>
          <ul>
            <li>Add new roles by editing the <code>ROLES</code> array in JavaScript</li>
            <li>Add new traits by editing the <code>TRAITS</code> array</li>
            <li>Customize colors and styling by modifying CSS variables in <code>:root</code></li>
            <li>Add new chart types by extending the <code>renderCharts()</code> function</li>
            <li>Modify splash timing by changing <code>SPLASH_MS</code></li>
          </ul>

          <h3>Troubleshooting</h3>
          <p>
            <strong>Nothing is saving:</strong> Make sure your browser allows IndexedDB. Check
            browser settings for storage permissions.
          </p>
          <p>
            <strong>Charts not showing:</strong> Charts render after you submit at least one round
            of votes. Import some Share Packs to see more data.
          </p>
          <p>
            <strong>Share Packs not working:</strong> Ensure files are valid JSON and haven't been
            corrupted. Check the browser console (F12) for error messages.
          </p>
        </div>
      </section>

    </main>

    <!-- =========================================================
      Footer - Attribution and Zero-Harm Reminder
      Purpose: Persistent reminder of ethical constraints
      Attribution: Foster + Navi / Planetary Restoration Archive
    ========================================================== -->
    <footer class="wrap" style="padding: 30px 0 60px; color: var(--muted); font-size: 13px; line-height: 1.8;">
      <div class="sep"></div>
      <p>
        <strong>LEGO War on Narratives</strong> ‚Ä¢ Enhanced Multiplayer Platform<br />
        Created by <a href="https://www.planetaryrestorationarchive.com" target="_blank" rel="noopener">Foster + Navi</a>
      </p>
      <p style="margin-top: 12px;">
        <strong>Zero-Harm & Anti-Coercion Notice:</strong> This system exists to channel narrative
        energy into safe, inspectable, collaborative deliberation. It is designed to prevent
        harassment, targeting, manipulation, and coercion. No telemetry. No tracking. No automatic
        sync. All data stays local. Manual coordination only.
      </p>
      <p style="margin-top: 12px; font-size: 12px; color: var(--muted2);">
        Open-source. Auditable. Resettable. Built for peace.
      </p>
    </footer>
  </div>

  <!--
    =========================================================================
    JavaScript - Core Application Logic
    =========================================================================
    
    Structure:
    1. Constants & Configuration
    2. Particle System (Canvas Animation)
    3. IndexedDB Wrapper (Persistent Storage)
    4. State Management
    5. UI Initialization
    6. Event Handlers
    7. Voting Logic
    8. Multiplayer (Export/Import)
    9. Dashboard & Charts
    10. Search Functionality
    11. Utility Functions
    
    Design Principles:
    - Local-first: All data in IndexedDB, no server calls
    - Defensive: Input sanitization, error handling
    - Accessible: ARIA labels, keyboard navigation
    - Performant: RequestAnimationFrame, debounced events
    - Transparent: Inline comments explain all major blocks
  -->
  <script>
    /* =========================================================
      Constants & Configuration
      Purpose: Central place to tweak behavior
      How to extend: Add new roles, traits, or adjust timing
    ========================================================== */
    const SPLASH_MS = 5000; // Splash screen auto-dismiss time (milliseconds)
    const STORAGE_NAME = "legoWarDB"; // IndexedDB database name
    const STORAGE_VERSION = 1; // Schema version

    // Role definitions with weighted categories
    // Each role has expertise in certain areas (e.g., Steward = +15% in sustainability)
    const ROLES = [
      {
        id: "architect",
        name: "Architect",
        desc: "Specializes in mechanisms and design. Votes weighted +10% in mechanics.",
        weight: { mechanics: 1.1 }
      },
      {
        id: "steward",
        name: "Steward",
        desc: "Focuses on sustainability and long-term health. Votes weighted +15% in sustainability.",
        weight: { sustainability: 1.15 }
      },
      {
        id: "auditor",
        name: "Auditor",
        desc: "Expert at identifying abuse vectors and vulnerabilities. Votes weighted +20% in abuse.",
        weight: { abuse: 1.2 }
      },
      {
        id: "mediator",
        name: "Mediator",
        desc: "Skilled in synthesis and bridging divides. Votes weighted +15% in synthesis.",
        weight: { synthesis: 1.15 }
      },
      {
        id: "historian",
        name: "Historian",
        desc: "Considers precedent and long-term consequences. Votes weighted +10% in precedent.",
        weight: { precedent: 1.1 }
      },
      {
        id: "citizen",
        name: "Citizen",
        desc: "General participant with no specialized weighting. All votes equal.",
        weight: {}
      }
    ];

    // Trait definitions (voting spectrums)
    // Each trait has a left pole, right pole, and category for weighted voting
    const TRAITS = [
      {
        id: "transparency",
        label: "Transparency ‚Üî Opacity",
        left: "Full Transparency",
        right: "Strategic Opacity",
        cat: "abuse",
        desc: "Should processes be fully open or strategically private?"
      },
      {
        id: "reversibility",
        label: "Reversibility ‚Üî Permanence",
        left: "Easily Reversible",
        right: "Locked Permanent",
        cat: "sustainability",
        desc: "Should decisions be easy to undo or committed long-term?"
      },
      {
        id: "speed",
        label: "Deliberation ‚Üî Speed",
        left: "Slow Deliberation",
        right: "Fast Action",
        cat: "mechanics",
        desc: "Should we move slowly with care or quickly with urgency?"
      },
      {
        id: "autonomy",
        label: "Local Autonomy ‚Üî Central Coordination",
        left: "Local Control",
        right: "Central Authority",
        cat: "synthesis",
        desc: "Who decides‚Äîcommunities or centralized systems?"
      },
      {
        id: "compassion",
        label: "Compassion Bias ‚Üî Efficiency Bias",
        left: "Compassion First",
        right: "Efficiency First",
        cat: "precedent",
        desc: "Prioritize human welfare or operational efficiency?"
      }
    ];

    /* =========================================================
      Particle System - Animated Background
      Purpose: Create immersive, calming visual experience
      How it works: Canvas-based particle physics with connections
      Performance: RequestAnimationFrame, connection distance limits
    ========================================================== */
    const canvas = document.getElementById("particleCanvas");
    const ctx = canvas.getContext("2d");
    let particles = [];
    let animationId = null;

    // Particle class with physics
    class Particle {
      constructor() {
        this.x = Math.random() * canvas.width;
        this.y = Math.random() * canvas.height;
        this.vx = (Math.random() - 0.5) * 0.5;
        this.vy = (Math.random() - 0.5) * 0.5;
        this.radius = Math.random() * 2 + 1;
        this.opacity = Math.random() * 0.5 + 0.3;
      }

      update() {
        this.x += this.vx;
        this.y += this.vy;

        // Wrap around edges
        if (this.x < 0) this.x = canvas.width;
        if (this.x > canvas.width) this.x = 0;
        if (this.y < 0) this.y = canvas.height;
        if (this.y > canvas.height) this.y = 0;
      }

      draw() {
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
        ctx.fillStyle = `rgba(122, 162, 255, ${this.opacity})`;
        ctx.fill();
      }
    }

    // Initialize particle system
    function initParticles() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      particles = [];
      
      // Create particles based on screen size (more on larger screens)
      const particleCount = Math.floor((canvas.width * canvas.height) / 15000);
      for (let i = 0; i < particleCount; i++) {
        particles.push(new Particle());
      }
    }

    // Animation loop
    function animateParticles() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Update and draw particles
      particles.forEach(p => {
        p.update();
        p.draw();
      });

      // Draw connections between nearby particles
      for (let i = 0; i < particles.length; i++) {
        for (let j = i + 1; j < particles.length; j++) {
          const dx = particles[i].x - particles[j].x;
          const dy = particles[i].y - particles[j].y;
          const distance = Math.sqrt(dx * dx + dy * dy);

          // Only connect if within range
          if (distance < 120) {
            ctx.beginPath();
            ctx.moveTo(particles[i].x, particles[i].y);
            ctx.lineTo(particles[j].x, particles[j].y);
            ctx.strokeStyle = `rgba(122, 162, 255, ${0.15 * (1 - distance / 120)})`;
            ctx.lineWidth = 0.5;
            ctx.stroke();
          }
        }
      }

      animationId = requestAnimationFrame(animateParticles);
    }

    // Handle window resize
    window.addEventListener("resize", () => {
      initParticles();
    });

    // Start particle system
    initParticles();
    animateParticles();

    /* =========================================================
      IndexedDB Wrapper
      Purpose: Persistent local storage for all user data
      How it works: Opens DB, creates object stores, provides CRUD operations
      Schema: { profile, votes, imports, preferences }
    ========================================================== */
    let db = null;

    // Open or create database
    function openDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(STORAGE_NAME, STORAGE_VERSION);

        request.onerror = () => reject(request.error);
        request.onsuccess = () => {
          db = request.result;
          resolve(db);
        };

        // Create schema on first run or version upgrade
        request.onupgradeneeded = (e) => {
          const database = e.target.result;

          // Profile store: user identity and role
          if (!database.objectStoreNames.contains("profile")) {
            database.createObjectStore("profile", { keyPath: "id" });
          }

          // Votes store: all voting rounds
          if (!database.objectStoreNames.contains("votes")) {
            const voteStore = database.createObjectStore("votes", {
              keyPath: "id",
              autoIncrement: true
            });
            voteStore.createIndex("round", "round", { unique: false });
          }

          // Imports store: share packs from others
          if (!database.objectStoreNames.contains("imports")) {
            database.createObjectStore("imports", {
              keyPath: "id",
              autoIncrement: true
            });
          }

          // Preferences store: UI settings, theme, etc.
          if (!database.objectStoreNames.contains("preferences")) {
            database.createObjectStore("preferences", { keyPath: "key" });
          }
        };
      });
    }

    // Save data to a store
    function saveData(storeName, data) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([storeName], "readwrite");
        const store = transaction.objectStore(storeName);
        const request = store.put(data);

        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    }

    // Load data from a store
    function loadData(storeName, key) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([storeName], "readonly");
        const store = transaction.objectStore(storeName);
        const request = store.get(key);

        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    }

    // Load all data from a store
    function loadAllData(storeName) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([storeName], "readonly");
        const store = transaction.objectStore(storeName);
        const request = store.getAll();

        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    }

    // Delete data from a store
    function deleteData(storeName, key) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([storeName], "readwrite");
        const store = transaction.objectStore(storeName);
        const request = store.delete(key);

        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
      });
    }

    // Clear entire store
    function clearStore(storeName) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([storeName], "readwrite");
        const store = transaction.objectStore(storeName);
        const request = store.clear();

        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
      });
    }

    /* =========================================================
      State Management
      Purpose: In-memory cache of user data
      Synced with IndexedDB on every change
    ========================================================== */
    const state = {
      profile: null,
      currentRound: 0,
      votes: [],
      imports: []
    };

    /* =========================================================
      Toast Notification System
      Purpose: User feedback for actions
      How to use: toast(message, type, subtitle)
      Types: good, warn, bad, info
    ========================================================== */
    function toast(msg, type = "good", sub = "") {
      const t = document.createElement("div");
      t.className = `toast ${type}`;
      t.innerHTML = `
        <div class="dot" aria-hidden="true"></div>
        <div>
          <div class="t">${sanitize(msg)}</div>
          ${sub ? `<div class="s">${sanitize(sub)}</div>` : ""}
        </div>
      `;
      
      const container = document.getElementById("toasts");
      container.appendChild(t);
      
      // Auto-remove after 4.2 seconds
      setTimeout(() => {
        t.style.opacity = "0";
        t.style.transform = "translateX(400px)";
        setTimeout(() => t.remove(), 300);
      }, 4200);
    }

    /* =========================================================
      Input Sanitization
      Purpose: Prevent XSS and injection attacks
      How it works: Escapes HTML special characters
    ========================================================== */
    function sanitize(str) {
      const div = document.createElement("div");
      div.textContent = str;
      return div.innerHTML;
    }

    /* =========================================================
      Splash Screen Logic
      Purpose: Welcome experience with auto-dismiss
      Features: Countdown timer, manual dismiss, fade out
    ========================================================== */
    const splash = document.getElementById("splash");
    const countdownValue = document.getElementById("countdownValue");
    let splashTimer = Math.floor(SPLASH_MS / 1000);

    // Countdown display
    const countdownInterval = setInterval(() => {
      splashTimer--;
      if (countdownValue) countdownValue.textContent = splashTimer;
      if (splashTimer <= 0) clearInterval(countdownInterval);
    }, 1000);

    // Close splash function
    function closeSplash() {
      clearInterval(countdownInterval);
      splash.classList.add("fadeOut");
      setTimeout(() => (splash.style.display = "none"), 300);
    }

    // Event listeners for splash dismiss
    document.getElementById("splashEnter").onclick = closeSplash;
    document.getElementById("splashLearn").onclick = () => {
      closeSplash();
      document.getElementById("help").scrollIntoView({ behavior: "smooth" });
    };

    // Auto-dismiss after timer
    setTimeout(closeSplash, SPLASH_MS);

    // Escape key closes splash
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && splash.style.display !== "none") {
        closeSplash();
      }
    });

    /* =========================================================
      UI Initialization
      Purpose: Build dynamic interface elements on page load
      Features: Role cards, selects, custom side input toggle
    ========================================================== */
    async function initUI() {
      // Populate role grid
      const roleGrid = document.getElementById("roleGrid");
      ROLES.forEach((role) => {
        const card = document.createElement("div");
        card.className = "roleCard";
        card.dataset.roleId = role.id;
        
        const weights = Object.entries(role.weight)
          .map(([cat, mult]) => `<span class="weightBadge">${cat} √ó${mult}</span>`)
          .join("");

        card.innerHTML = `
          <h4>${role.name}</h4>
          <p>${role.desc}</p>
          <div class="roleWeights">${weights || '<span class="weightBadge">No weights</span>'}</div>
        `;

        // Click to select role
        card.onclick = () => {
          document.querySelectorAll(".roleCard").forEach((c) => c.classList.remove("selected"));
          card.classList.add("selected");
          state.profile = state.profile || {};
          state.profile.role = role.id;
        };

        roleGrid.appendChild(card);
      });

      // Custom side input toggle
      document.getElementById("sideLabel").onchange = (e) => {
        document.getElementById("customSideWrap").style.display =
          e.target.value === "Other" ? "block" : "none";
      };

      // Load saved profile
      try {
        const savedProfile = await loadData("profile", "main");
        if (savedProfile) {
          state.profile = savedProfile;
          if (savedProfile.username) {
            document.getElementById("username").value = savedProfile.username;
          }
          if (savedProfile.side) {
            const select = document.getElementById("sideLabel");
            if ([...select.options].some(opt => opt.value === savedProfile.side)) {
              select.value = savedProfile.side;
            } else {
              select.value = "Other";
              document.getElementById("customSideWrap").style.display = "block";
              document.getElementById("customSide").value = savedProfile.side;
            }
          }
          if (savedProfile.role) {
            const card = document.querySelector(`[data-role-id="${savedProfile.role}"]`);
            if (card) card.classList.add("selected");
          }
          toast("Profile loaded", "info");
        }
      } catch (err) {
        console.error("Error loading profile:", err);
      }

      // Load votes and update state
      try {
        const allVotes = await loadAllData("votes");
        state.votes = allVotes || [];
        state.currentRound = state.votes.length;
        updateDashboard();
      } catch (err) {
        console.error("Error loading votes:", err);
      }

      // Load imports
      try {
        const allImports = await loadAllData("imports");
        state.imports = allImports || [];
        renderImportList();
        updateDashboard();
      } catch (err) {
        console.error("Error loading imports:", err);
      }
    }

    /* =========================================================
      Profile Save
      Purpose: Persist user identity and role to IndexedDB
      Validation: Ensures username and role are set
    ========================================================== */
    document.getElementById("btnSaveProfile").onclick = async () => {
      const username = document.getElementById("username").value.trim();
      const sideLabel = document.getElementById("sideLabel").value;
      const customSide = document.getElementById("customSide").value.trim();
      const side = sideLabel === "Other" ? customSide : sideLabel;

      if (!username) {
        toast("Please enter a name", "warn");
        return;
      }

      if (!state.profile || !state.profile.role) {
        toast("Please select a role", "warn");
        return;
      }

      state.profile.id = "main";
      state.profile.username = username;
      state.profile.side = side;

      try {
        await saveData("profile", state.profile);
        toast("Profile saved", "good", "All changes stored locally");
      } catch (err) {
        console.error("Error saving profile:", err);
        toast("Error saving profile", "bad", err.message);
      }
    };

    /* =========================================================
      Voting Logic
      Purpose: Create rounds, collect votes, save to DB
      Features: Dynamic trait rendering, range sliders, reflection
    ========================================================== */
    document.getElementById("btnNewRound").onclick = () => {
      state.currentRound++;
      document.getElementById("roundLabel").textContent = state.currentRound;

      const list = document.getElementById("voteList");
      list.innerHTML = "";

      TRAITS.forEach((trait) => {
        const card = document.createElement("div");
        card.className = "voteCard";
        card.innerHTML = `
          <div class="voteTop">
            <div>
              <h4>${trait.label}</h4>
              <div class="meta">${trait.cat}</div>
            </div>
          </div>
          <p style="color: var(--muted2); font-size: 13px; margin-bottom: 12px;">
            ${trait.desc}
          </p>
          <div class="axis">
            <div class="pole">${trait.left}</div>
            <input
              type="range"
              min="-2"
              max="2"
              step="1"
              value="0"
              data-id="${trait.id}"
              aria-label="${trait.label}"
            />
            <div class="value">0</div>
            <div class="pole">${trait.right}</div>
          </div>
        `;
        list.appendChild(card);
      });

      // Update value display on slider change
      document.querySelectorAll('input[type="range"]').forEach((slider) => {
        slider.oninput = () => {
          const valueDiv = slider.nextElementSibling;
          valueDiv.textContent = slider.value;
          
          // Color code based on value
          const val = parseInt(slider.value);
          if (val < -1) valueDiv.style.color = "var(--bad)";
          else if (val > 1) valueDiv.style.color = "var(--good)";
          else valueDiv.style.color = "var(--accent)";
        };
      });

      // Enable submit button
      document.getElementById("btnSubmitVotes").disabled = false;
      
      toast("New round started", "good", `Round ${state.currentRound}`);
    };

    // Submit votes to IndexedDB
    document.getElementById("btnSubmitVotes").onclick = async () => {
      const sliders = document.querySelectorAll('input[type="range"]');
      const vals = Array.from(sliders).map((slider) => ({
        trait: slider.dataset.id,
        value: parseInt(slider.value)
      }));

      const reflection = document.getElementById("reflectionNotes").value.trim();

      const voteRecord = {
        round: state.currentRound,
        timestamp: Date.now(),
        vals,
        reflection,
        role: state.profile ? state.profile.role : "citizen"
      };

      try {
        await saveData("votes", voteRecord);
        state.votes.push(voteRecord);
        toast("Votes saved", "good", "Stored locally in your browser");
        
        // Clear reflection
        document.getElementById("reflectionNotes").value = "";
        
        // Update dashboard
        updateDashboard();
      } catch (err) {
        console.error("Error saving votes:", err);
        toast("Error saving votes", "bad", err.message);
      }
    };

    // Clear current round
    document.getElementById("btnClearVotes").onclick = () => {
      document.querySelectorAll('input[type="range"]').forEach((slider) => {
        slider.value = 0;
        slider.nextElementSibling.textContent = "0";
        slider.nextElementSibling.style.color = "var(--accent)";
      });
      document.getElementById("reflectionNotes").value = "";
      toast("Round cleared", "info");
    };

    /* =========================================================
      Multiplayer - Export/Import Share Packs
      Purpose: Manual peer coordination via JSON files
      Design: No auto-sync, consent-based sharing
    ========================================================== */
    document.getElementById("btnExport").onclick = async () => {
      if (!state.profile || !state.profile.username) {
        toast("Please save your profile first", "warn");
        return;
      }

      const pack = {
        version: 1,
        session: {
          id: crypto.randomUUID(),
          username: state.profile.username,
          role: state.profile.role,
          side: state.profile.side || ""
        },
        rounds: state.votes,
        timestamp: Date.now()
      };

      const blob = new Blob([JSON.stringify(pack, null, 2)], {
        type: "application/json"
      });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `lego-war-share-${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(url);

      toast("Share Pack exported", "good", "Send this file to trusted peers");
    };

    // Import share pack
    document.getElementById("btnImport").onclick = () => {
      document.getElementById("importFile").click();
    };

    document.getElementById("importFile").onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async () => {
        try {
          const pack = JSON.parse(reader.result);

          // Basic validation
          if (!pack.session || !pack.rounds) {
            throw new Error("Invalid share pack format");
          }

          // Save to imports store
          const importRecord = {
            ...pack,
            importedAt: Date.now()
          };

          await saveData("imports", importRecord);
          state.imports.push(importRecord);

          toast("Share Pack imported", "good", `From ${pack.session.username}`);
          renderImportList();
          updateDashboard();
        } catch (err) {
          console.error("Import error:", err);
          toast("Failed to import", "bad", err.message);
        }
      };
      reader.readAsText(file);
    };

    // Clear all imports
    document.getElementById("btnClearImports").onclick = async () => {
      if (confirm("Clear all imported share packs? This cannot be undone.")) {
        try {
          await clearStore("imports");
          state.imports = [];
          toast("Imports cleared", "warn");
          renderImportList();
          updateDashboard();
        } catch (err) {
          console.error("Error clearing imports:", err);
          toast("Error clearing imports", "bad", err.message);
        }
      }
    };

    // Render import list
    function renderImportList() {
      const list = document.getElementById("importList");
      
      if (state.imports.length === 0) {
        list.innerHTML = '<p style="color: var(--muted2); font-size: 13px;">No imports yet.</p>';
        return;
      }

      list.innerHTML = state.imports
        .map((imp, idx) => {
          const date = new Date(imp.importedAt).toLocaleDateString();
          return `
            <div style="padding: 12px; background: rgba(83, 243, 166, .06); border: 1px solid rgba(83, 243, 166, .2); border-radius: 12px; margin-bottom: 8px;">
              <strong>${sanitize(imp.session.username)}</strong> (${imp.session.role})
              <div style="font-size: 12px; color: var(--muted2); margin-top: 4px;">
                ${imp.rounds.length} rounds ‚Ä¢ Imported ${date}
              </div>
            </div>
          `;
        })
        .join("");
    }

    /* =========================================================
      Dashboard & Visualizations
      Purpose: Show voting patterns, consensus, diversity
      How it works: Aggregate data from state.votes and state.imports
      Charts: Distribution histogram, consensus heatmap
    ========================================================== */
    function updateDashboard() {
      // Update stat cards
      document.getElementById("statRounds").textContent = state.votes.length;
      
      const totalVotes = state.votes.reduce((sum, v) => sum + v.vals.length, 0);
      document.getElementById("statVotes").textContent = totalVotes;
      
      document.getElementById("statImports").textContent = state.imports.length;

      // Render charts if we have data
      if (state.votes.length > 0 || state.imports.length > 0) {
        renderCharts();
      }

      // Update community patterns
      renderCommunityPatterns();
    }

    // Simple chart rendering (placeholder - real charts would use library)
    function renderCharts() {
      // Distribution chart
      const distCanvas = document.getElementById("distributionChart");
      const distCtx = distCanvas.getContext("2d");
      distCanvas.width = distCanvas.offsetWidth;
      distCanvas.height = distCanvas.offsetHeight;

      // Aggregate all votes
      const aggregated = {};
      TRAITS.forEach(t => aggregated[t.id] = { "-2": 0, "-1": 0, "0": 0, "1": 0, "2": 0 });

      [...state.votes, ...state.imports.flatMap(imp => imp.rounds)].forEach(round => {
        round.vals.forEach(v => {
          if (aggregated[v.trait]) {
            aggregated[v.trait][v.value.toString()]++;
          }
        });
      });

      // Draw simple bar chart
      distCtx.fillStyle = "rgba(255, 255, 255, 0.1)";
      distCtx.fillRect(0, 0, distCanvas.width, distCanvas.height);

      const barWidth = distCanvas.width / (TRAITS.length * 5);
      const maxCount = Math.max(...Object.values(aggregated).flatMap(v => Object.values(v)));

      TRAITS.forEach((trait, i) => {
        const data = aggregated[trait.id];
        ["-2", "-1", "0", "1", "2"].forEach((val, j) => {
          const count = data[val];
          const height = (count / (maxCount || 1)) * (distCanvas.height - 40);
          const x = i * barWidth * 5 + j * barWidth;
          const y = distCanvas.height - height - 20;

          distCtx.fillStyle = `rgba(122, 162, 255, 0.${Math.floor(count / (maxCount || 1) * 9)})`;
          distCtx.fillRect(x, y, barWidth * 0.8, height);
        });
      });

      // Consensus chart (simplified heatmap)
      const consCanvas = document.getElementById("consensusChart");
      const consCtx = consCanvas.getContext("2d");
      consCanvas.width = consCanvas.offsetWidth;
      consCanvas.height = consCanvas.offsetHeight;

      consCtx.fillStyle = "rgba(255, 255, 255, 0.1)";
      consCtx.fillRect(0, 0, consCanvas.width, consCanvas.height);

      // Calculate standard deviation for each trait (spread = lower consensus)
      TRAITS.forEach((trait, i) => {
        const values = [...state.votes, ...state.imports.flatMap(imp => imp.rounds)]
          .flatMap(round => round.vals.filter(v => v.trait === trait.id).map(v => v.value));

        if (values.length === 0) return;

        const mean = values.reduce((a, b) => a + b, 0) / values.length;
        const variance = values.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / values.length;
        const stdDev = Math.sqrt(variance);

        // Low stdDev = high consensus (bright), high stdDev = low consensus (dim)
        const consensus = Math.max(0, 1 - stdDev / 2);
        
        const x = (i / TRAITS.length) * consCanvas.width;
        const width = consCanvas.width / TRAITS.length;

        consCtx.fillStyle = `rgba(83, 243, 166, ${consensus})`;
        consCtx.fillRect(x, 0, width, consCanvas.height);

        // Label
        consCtx.fillStyle = "rgba(255, 255, 255, 0.8)";
        consCtx.font = "12px sans-serif";
        consCtx.fillText(trait.id.substr(0, 4), x + 10, 20);
      });
    }

    // Generate community insights
    function renderCommunityPatterns() {
      const list = document.getElementById("communityPatterns");
      
      if (state.imports.length === 0) {
        list.innerHTML = '<li>Import share packs to see community patterns</li>';
        return;
      }

      const patterns = [];

      // Calculate role diversity
      const roles = [
        ...state.votes.map(v => v.role),
        ...state.imports.flatMap(imp => imp.rounds.map(r => r.role))
      ];
      const uniqueRoles = new Set(roles);
      patterns.push(`Role diversity: ${uniqueRoles.size} different roles represented`);

      // Calculate average position per trait
      TRAITS.forEach(trait => {
        const values = [
          ...state.votes.flatMap(v => v.vals.filter(val => val.trait === trait.id).map(val => val.value)),
          ...state.imports.flatMap(imp => imp.rounds.flatMap(r => r.vals.filter(val => val.trait === trait.id).map(val => val.value)))
        ];

        if (values.length > 0) {
          const avg = values.reduce((a, b) => a + b, 0) / values.length;
          const direction = avg < -0.5 ? trait.left : avg > 0.5 ? trait.right : "Balanced";
          patterns.push(`${trait.label}: Community leans toward "${direction}"`);
        }
      });

      list.innerHTML = patterns.map(p => `<li>${p}</li>`).join("");
    }

    /* =========================================================
      Search Functionality
      Purpose: Fast client-side keyword search
      How it works: Matches against roles, traits, and help text
      Accessibility: Results announced to screen readers
    ========================================================== */
    const searchInput = document.getElementById("searchInput");
    const searchResults = document.getElementById("searchResults");

    // Debounced search function
    let searchTimeout;
    searchInput.oninput = () => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        const query = searchInput.value.trim().toLowerCase();
        
        if (query.length < 2) {
          searchResults.innerHTML = "";
          return;
        }

        const results = [];

        // Search roles
        ROLES.forEach(role => {
          if (role.name.toLowerCase().includes(query) || role.desc.toLowerCase().includes(query)) {
            results.push({
              title: role.name,
              desc: role.desc,
              category: "Role",
              action: () => {
                document.getElementById("profile").scrollIntoView({ behavior: "smooth" });
              }
            });
          }
        });

        // Search traits
        TRAITS.forEach(trait => {
          if (
            trait.label.toLowerCase().includes(query) ||
            trait.left.toLowerCase().includes(query) ||
            trait.right.toLowerCase().includes(query) ||
            trait.desc.toLowerCase().includes(query)
          ) {
            results.push({
              title: trait.label,
              desc: trait.desc,
              category: "Voting Trait",
              action: () => {
                document.getElementById("voting").scrollIntoView({ behavior: "smooth" });
              }
            });
          }
        });

        // Search help topics
        const helpKeywords = [
          { term: "reversibility", desc: "Ability to undo decisions", section: "help" },
          { term: "coercion", desc: "Zero-harm and anti-coercion principles", section: "safety" },
          { term: "steward", desc: "Role focused on sustainability", section: "profile" },
          { term: "multiplayer", desc: "Share packs and coordination", section: "multiplayer" },
          { term: "transparency", desc: "Voting trait about openness", section: "voting" }
        ];

        helpKeywords.forEach(kw => {
          if (kw.term.includes(query) || kw.desc.toLowerCase().includes(query)) {
            results.push({
              title: kw.term,
              desc: kw.desc,
              category: "Help Topic",
              action: () => {
                document.getElementById(kw.section).scrollIntoView({ behavior: "smooth" });
              }
            });
          }
        });

        // Render results
        if (results.length === 0) {
          searchResults.innerHTML = '<p style="color: var(--muted2); font-size: 13px; padding: 12px;">No results found.</p>';
          return;
        }

        searchResults.innerHTML = results
          .slice(0, 10)
          .map(r => `
            <div class="searchResult" onclick="(${r.action.toString()})()">
              <strong>${sanitize(r.title)}</strong>
              <div>${sanitize(r.desc)}</div>
              <div class="category">${r.category}</div>
            </div>
          `)
          .join("");
      }, 300);
    };

    /* =========================================================
      Reset Function
      Purpose: Wipe all local data
      Safety: Requires confirmation
    ========================================================== */
    document.getElementById("btnReset").onclick = async () => {
      if (confirm("‚ö†Ô∏è This will permanently delete all your local data (profile, votes, imports). This cannot be undone. Continue?")) {
        try {
          await clearStore("profile");
          await clearStore("votes");
          await clearStore("imports");
          await clearStore("preferences");

          state.profile = null;
          state.currentRound = 0;
          state.votes = [];
          state.imports = [];

          toast("All data reset", "bad", "Browser returned to clean state");
          
          // Reload page after short delay
          setTimeout(() => location.reload(), 1500);
        } catch (err) {
          console.error("Error resetting data:", err);
          toast("Error resetting data", "bad", err.message);
        }
      }
    };

    /* =========================================================
      Theme Toggle (Placeholder)
      Purpose: Future feature for light/dark theme switching
    ========================================================== */
    document.getElementById("btnToggleTheme").onclick = () => {
      toast("Theme switching coming soon", "info");
    };

    /* =========================================================
      Help Button
      Purpose: Quick access to documentation
    ========================================================== */
    document.getElementById("btnHelp").onclick = () => {
      document.getElementById("help").scrollIntoView({ behavior: "smooth" });
    };

    /* =========================================================
      Service Worker Registration (Offline-First)
      Purpose: Enable offline functionality
      How it works: Caches assets for offline access
      Note: Requires HTTPS in production
    ========================================================== */
    if ("serviceWorker" in navigator) {
      // Service worker code would go here
      // For standalone HTML, we skip actual registration
      // In production, create separate sw.js file
      console.log("Service worker supported (not registered in this demo)");
    }

    /* =========================================================
      Initialize Application
      Purpose: Bootstrap everything on page load
      Order: Open DB ‚Üí Init UI ‚Üí Register SW
    ========================================================== */
    (async function init() {
      try {
        await openDB();
        await initUI();
        console.log("Platform initialized successfully");
      } catch (err) {
        console.error("Initialization error:", err);
        toast("Error initializing platform", "bad", err.message);
      }
    })();

    /* =========================================================
      Keyboard Shortcuts
      Purpose: Power user features
      Shortcuts: Ctrl+S (save profile), Ctrl+E (export), Ctrl+/ (help)
    ========================================================== */
    document.addEventListener("keydown", (e) => {
      if (e.ctrlKey || e.metaKey) {
        switch (e.key) {
          case "s":
            e.preventDefault();
            document.getElementById("btnSaveProfile").click();
            break;
          case "e":
            e.preventDefault();
            document.getElementById("btnExport").click();
            break;
          case "/":
            e.preventDefault();
            document.getElementById("btnHelp").click();
            break;
        }
      }
    });

    /* =========================================================
      Analytics Stub (Intentionally Empty)
      Purpose: Document that we explicitly don't track users
      Philosophy: Zero telemetry is a feature, not a bug
    ========================================================== */
    // NO ANALYTICS. NO TRACKING. NO TELEMETRY.
    // This section exists to explicitly document that we don't track users.
    // If you fork this project, please maintain this principle.

  </script>

  <!--
    =========================================================================
    Zero-Harm & Anti-Inversion Final Comment
    =========================================================================
    
    This platform is designed from first principles to prevent harm:
    
    1. No coercion: Manual coordination only, no automatic peer pressure
    2. No targeting: No personal identifiers exposed beyond chosen pseudonyms
    3. No manipulation: Transparent algorithms, no dark patterns
    4. No surveillance: Zero telemetry, zero tracking, zero analytics
    5. No lock-in: Full reset capability, portable JSON exports
    
    The architecture itself enforces these constraints. They are not policies
    that can be violated‚Äîthey are structural impossibilities.
    
    If you fork this code, please honor these principles. They exist to protect
    real people from real harm.
    
    Built with care by Foster + Navi
    For planetary restoration and peace-building
    =========================================================================
  -->
</body>
</html>
